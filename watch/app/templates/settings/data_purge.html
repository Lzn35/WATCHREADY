{% extends "base.html" %}

{% block title %}Data Purge Management - WATCH{% endblock %}

{% block content %}
<div class="main-container">
	<div class="pd-ltr-20">
		
		<!-- Page Header -->
		<div class="page-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
			<div class="row align-items-center">
				<div class="col-md-12">
					<h4 class="mb-0">
						<i class="fa fa-database" style="margin-right: 10px;"></i>
						Data Purge Management
					</h4>
					<p class="mb-0" style="margin-top: 8px; opacity: 0.9;">
						Manage graduated students and archived data - Panel Recommendation
					</p>
				</div>
			</div>
		</div>

		<!-- Alert Info -->
		<div class="alert alert-info">
			<i class="fa fa-info-circle" style="margin-right: 8px;"></i>
			<strong>Panel Recommendation:</strong> Purge data from graduated students after the school year ends. All data is archived to CSV before deletion.
		</div>

		<!-- Graduated Sections Management -->
		<div class="card-box mb-30">
			<div class="pd-20">
				<h5 class="mb-3">
					<i class="fa fa-graduation-cap" style="margin-right: 8px;"></i>
					Graduated Sections
				</h5>
				
				<div class="table-responsive">
					<table class="table table-striped table-hover">
						<thead>
							<tr>
								<th>Section Code</th>
								<th>Program</th>
								<th>Year Level</th>
								<th>Academic Year</th>
								<th>Graduation Date</th>
								<th>Student Count</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody id="graduatedSectionsTable">
							{% if graduated_sections %}
								{% for section in graduated_sections %}
								<tr>
									<td><strong>{{ section.section_code }}</strong></td>
									<td>{{ section.program }}</td>
									<td>{{ section.year_level }}</td>
									<td>{{ section.academic_year }}</td>
									<td>{{ section.graduation_date.strftime('%B %d, %Y') if section.graduation_date else 'Not set' }}</td>
									<td><span class="badge badge-primary" id="student-count-{{ section.id }}">Loading...</span></td>
									<td>
										<button class="btn btn-sm btn-danger" onclick="purgeSection({{ section.id }}, '{{ section.section_code }}')">
											<i class="fa fa-trash"></i> Purge Students
										</button>
									</td>
								</tr>
								{% endfor %}
							{% else %}
								<tr>
									<td colspan="7" class="text-center text-muted">
										<i class="fa fa-info-circle"></i> No graduated sections found.
									</td>
								</tr>
							{% endif %}
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<!-- Active Sections - Mark as Graduated -->
		<div class="card-box mb-30">
			<div class="pd-20">
				<h5 class="mb-3">
					<i class="fa fa-users" style="margin-right: 8px;"></i>
					Active Sections
				</h5>
				
				<p class="text-muted">Mark sections as graduated to enable data purging.</p>
				
				<div class="table-responsive">
					<table class="table table-striped table-hover">
						<thead>
							<tr>
								<th>Section Code</th>
								<th>Program</th>
								<th>Year Level</th>
								<th>Academic Year</th>
								<th>Student Count</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{% if active_sections %}
								{% for section in active_sections %}
								<tr>
									<td><strong>{{ section.section_code }}</strong></td>
									<td>{{ section.program }}</td>
									<td>{{ section.year_level }}</td>
									<td>{{ section.academic_year }}</td>
									<td><span class="badge badge-info" id="active-student-count-{{ section.id }}">Loading...</span></td>
									<td>
										<button class="btn btn-sm btn-success" onclick="markAsGraduated({{ section.id }}, '{{ section.section_code }}')">
											<i class="fa fa-graduation-cap"></i> Mark as Graduated
										</button>
									</td>
								</tr>
								{% endfor %}
							{% else %}
								<tr>
									<td colspan="6" class="text-center text-muted">
										<i class="fa fa-info-circle"></i> No active sections found.
									</td>
								</tr>
							{% endif %}
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<!-- Purge History/Archives -->
		<div class="card-box mb-30">
			<div class="pd-20">
				<h5 class="mb-3">
					<i class="fa fa-archive" style="margin-right: 8px;"></i>
					Purge Archives
				</h5>
				
				<p class="text-muted">CSV archives of purged data are stored in: <code>instance/archives/graduated_students/</code></p>
				
				<div id="archivesList">
					<p class="text-center text-muted">
						<i class="fa fa-folder-open"></i> Archives will appear here after purge operations.
					</p>
				</div>
			</div>
		</div>

	</div>
</div>

<script>
// Load student counts for graduated sections
{% for section in graduated_sections %}
	fetch('/api/students/count?section_id={{ section.id }}')
		.then(res => res.json())
		.then(data => {
			document.getElementById('student-count-{{ section.id }}').textContent = data.count || 0;
		})
		.catch(err => {
			document.getElementById('student-count-{{ section.id }}').textContent = '?';
		});
{% endfor %}

// Load student counts for active sections
{% for section in active_sections %}
	fetch('/api/students/count?section_id={{ section.id }}')
		.then(res => res.json())
		.then(data => {
			document.getElementById('active-student-count-{{ section.id }}').textContent = data.count || 0;
		})
		.catch(err => {
			document.getElementById('active-student-count-{{ section.id }}').textContent = '?';
		});
{% endfor %}

function markAsGraduated(sectionId, sectionCode) {
	// Show confirmation dialog
	if (!confirm(`Mark ${sectionCode} as graduated?\n\nThis will allow purging of students in this section.`)) {
		return;
	}
	
	// Prompt for graduation date
	const gradDate = prompt(`Enter graduation date for ${sectionCode}:\n(Format: YYYY-MM-DD)\n\nLeave empty to use today's date.`);
	
	// User cancelled
	if (gradDate === null) {
		return;
	}
	
	// Validate date format if provided
	if (gradDate && gradDate.trim() && !/^\d{4}-\d{2}-\d{2}$/.test(gradDate.trim())) {
		alert('Invalid date format. Please use YYYY-MM-DD format.');
		return;
	}
	
	// Send request
	const formData = new FormData();
	formData.append('csrf_token', document.querySelector('meta[name="csrf-token"]').content);
	if (gradDate && gradDate.trim()) {
		formData.append('graduation_date', gradDate.trim());
	}
	
	fetch(`/settings/sections/${sectionId}/graduate`, {
		method: 'POST',
		headers: {
			'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
		},
		body: formData
	})
	.then(res => res.json())
	.then(data => {
		if (data.success) {
			alert(`✅ ${data.message}`);
			location.reload();  // Reload to show updated sections
		} else {
			alert(`❌ Error: ${data.error || 'Failed to mark section as graduated'}`);
		}
	})
	.catch(err => {
		console.error('Error:', err);
		alert('❌ Network error. Please try again.');
	});
}

function purgeSection(sectionId, sectionCode) {
	// Show confirmation dialog
	if (!confirm(`⚠️ PURGE GRADUATED STUDENTS IN ${sectionCode}?\n\n` +
		`This will:\n` +
		`1. Archive all students and their cases to CSV\n` +
		`2. Permanently delete them from the database\n` +
		`3. This action CANNOT be undone!\n\n` +
		`Are you absolutely sure?`)) {
		return;
	}
	
	// Double confirmation
	const confirmation = prompt(`To confirm, type the section code: ${sectionCode}`);
	if (confirmation !== sectionCode) {
		alert('Section code does not match. Purge cancelled.');
		return;
	}
	
	// Show loading
	const button = event.target.closest('button');
	const originalText = button.innerHTML;
	button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Purging...';
	button.disabled = true;
	
	// Send purge request
	const formData = new FormData();
	formData.append('csrf_token', document.querySelector('meta[name="csrf-token"]').content);
	formData.append('section_id', sectionId);
	
	fetch('/settings/purge-graduated-students', {
		method: 'POST',
		headers: {
			'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
		},
		body: formData
	})
	.then(res => res.json())
	.then(data => {
		if (data.success) {
			alert(`✅ SUCCESS!\n\n` +
				`${data.message}\n\n` +
				`Students purged: ${data.count}\n` +
				(data.csv_path ? `Archive saved to: ${data.csv_path}` : ''));
			location.reload();
		} else {
			alert(`❌ Error: ${data.error || 'Failed to purge students'}`);
			button.innerHTML = originalText;
			button.disabled = false;
		}
	})
	.catch(err => {
		console.error('Error:', err);
		alert('❌ Network error. Please try again.');
		button.innerHTML = originalText;
		button.disabled = false;
	});
}
</script>

{% endblock %}

