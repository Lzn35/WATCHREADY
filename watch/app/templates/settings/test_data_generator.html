{% extends "base.html" %}

{% block title %}Test Data Generator - WATCH{% endblock %}

{% block content %}
<div class="pd-20 card-box mb-30">
	<div class="clearfix mb-3">
		<div class="pull-left">
			<h4 class="text-blue h4">
				<i class="bi bi-database-fill-gear" style="margin-right: 8px;"></i>
				Test Data Generator
			</h4>
		</div>
	</div>
	
	<!-- Info Banner -->
	<div class="alert alert-info" role="alert">
		<h5><i class="bi bi-info-circle"></i> Scalability Testing</h5>
		<p class="mb-0">
			Generate test data to demonstrate the system's scalability to the panel and beneficiaries.
			This creates a realistic dataset with thousands of records to show pagination, search, and performance optimization.
		</p>
	</div>
	
	<!-- Current Database Stats -->
	<div class="card mb-4">
		<div class="card-header">
			<h5 class="mb-0">Current Database Statistics</h5>
		</div>
		<div class="card-body">
			<div class="row">
				<div class="col-md-4">
					<div class="text-center p-3 bg-light rounded">
						<h3 class="mb-0">{{ stats.persons }}</h3>
						<p class="text-muted mb-0">Persons</p>
					</div>
				</div>
				<div class="col-md-4">
					<div class="text-center p-3 bg-light rounded">
						<h3 class="mb-0">{{ stats.cases }}</h3>
						<p class="text-muted mb-0">Cases</p>
					</div>
				</div>
				<div class="col-md-4">
					<div class="text-center p-3 bg-light rounded">
						<h3 class="mb-0">{{ stats.schedules }}</h3>
						<p class="text-muted mb-0">Schedules</p>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<!-- Generation Options -->
	<div class="card">
		<div class="card-header">
			<h5 class="mb-0">Generate Test Dataset</h5>
		</div>
		<div class="card-body">
			<p><strong>This will generate:</strong></p>
			<ul>
				<li>‚úÖ 300 Additional Schedules</li>
				<li>‚úÖ 1,000 Attendance Records</li>
				<li>‚úÖ 3,000 Persons (2,000 students, 500 faculty, 500 staff)</li>
				<li>‚úÖ 10,000 Cases (5,000 minor + 5,000 major, distributed across all types)</li>
				<li>‚úÖ 100 Appointments</li>
			</ul>
			
			<div class="alert alert-warning">
				<strong>‚è±Ô∏è Estimated time:</strong> 2-3 minutes<br>
				<strong>üìä Database size increase:</strong> ~50-100MB<br>
				<strong>üéØ Purpose:</strong> Demonstrate pagination and search with large dataset
			</div>
			
			<button id="generateBtn" class="btn btn-primary btn-lg" onclick="generateTestData()">
				<i class="bi bi-play-fill"></i> Generate Test Data
			</button>
			
			<div id="progressContainer" class="mt-4" style="display: none;">
				<h5>Generating Data...</h5>
				<div class="progress" style="height: 30px;">
					<div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
						 role="progressbar" style="width: 0%">
						<span id="progressText">0%</span>
					</div>
				</div>
				<p id="statusText" class="mt-2 text-muted"></p>
			</div>
			
			<div id="resultContainer" class="mt-4" style="display: none;">
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function generateTestData() {
	if (!confirm('Generate test data?\n\nThis will add ~10,000 cases to demonstrate scalability.\n\nContinue?')) {
		return;
	}
	
	// Disable button and show progress
	const btn = document.getElementById('generateBtn');
	btn.disabled = true;
	btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating...';
	
	document.getElementById('progressContainer').style.display = 'block';
	document.getElementById('resultContainer').style.display = 'none';
	
	// Simulate progress (actual generation happens on backend)
	let progress = 0;
	const progressInterval = setInterval(() => {
		progress += Math.random() * 10;
		if (progress > 95) progress = 95;
		
		document.getElementById('progressBar').style.width = progress + '%';
		document.getElementById('progressText').innerText = Math.round(progress) + '%';
		
		// Update status text
		if (progress < 20) {
			document.getElementById('statusText').innerText = 'Creating rooms and sections...';
		} else if (progress < 40) {
			document.getElementById('statusText').innerText = 'Generating schedules...';
		} else if (progress < 60) {
			document.getElementById('statusText').innerText = 'Creating persons (students, faculty, staff)...';
		} else if (progress < 90) {
			document.getElementById('statusText').innerText = 'Generating 10,000 cases...';
		} else {
			document.getElementById('statusText').innerText = 'Finalizing...';
		}
	}, 500);
	
	// Make API call
	fetch('{{ url_for("settings.generate_test_data") }}', {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
			'X-CSRFToken': '{{ csrf_token() }}'
		}
	})
	.then(response => response.json())
	.then(data => {
		clearInterval(progressInterval);
		
		document.getElementById('progressBar').style.width = '100%';
		document.getElementById('progressText').innerText = '100%';
		document.getElementById('statusText').innerText = 'Complete!';
		
		if (data.success) {
			document.getElementById('resultContainer').innerHTML = `
				<div class="alert alert-success">
					<h5><i class="bi bi-check-circle"></i> Test Data Generated Successfully!</h5>
					<p><strong>Generated:</strong></p>
					<ul>
						<li>Rooms: ${data.generated.rooms}</li>
						<li>Sections: ${data.generated.sections}</li>
						<li>Schedules: ${data.generated.schedules}</li>
						<li>Attendance: ${data.generated.attendance}</li>
						<li>Persons: ${data.generated.persons}</li>
						<li>Cases: ${data.generated.cases}</li>
						<li>Appointments: ${data.generated.appointments}</li>
					</ul>
					<p><strong>Database Totals:</strong></p>
					<ul>
						<li>Total Persons: ${data.totals.persons}</li>
						<li>Total Cases: ${data.totals.cases}</li>
						<li>Total Schedules: ${data.totals.schedules}</li>
					</ul>
					<p class="mb-0">
						<a href="{{ url_for('cases.major_cases_student') }}" class="btn btn-primary">
							<i class="bi bi-eye"></i> Test Major Cases Page
						</a>
					</p>
				</div>
			`;
			document.getElementById('resultContainer').style.display = 'block';
			
			// Re-enable button
			btn.disabled = false;
			btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Generate More Data';
		} else {
			document.getElementById('resultContainer').innerHTML = `
				<div class="alert alert-danger">
					<h5><i class="bi bi-x-circle"></i> Generation Failed</h5>
					<p>Error: ${data.error}</p>
				</div>
			`;
			document.getElementById('resultContainer').style.display = 'block';
			
			btn.disabled = false;
			btn.innerHTML = '<i class="bi bi-play-fill"></i> Retry Generation';
		}
	})
	.catch(error => {
		clearInterval(progressInterval);
		console.error('Error:', error);
		
		document.getElementById('resultContainer').innerHTML = `
			<div class="alert alert-danger">
				<h5><i class="bi bi-x-circle"></i> Network Error</h5>
				<p>Failed to generate test data. Please try again.</p>
			</div>
		`;
		document.getElementById('resultContainer').style.display = 'block';
		
		btn.disabled = false;
		btn.innerHTML = '<i class="bi bi-play-fill"></i> Retry Generation';
	});
}
</script>
{% endblock %}

