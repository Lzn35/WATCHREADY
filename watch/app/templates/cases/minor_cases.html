{% extends "base.html" %}

{% block title %}Minor Cases - WATCH{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='plugins/datatables/css/dataTables.bootstrap4.min.css') }}">
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='plugins/datatables/css/responsive.bootstrap4.min.css') }}">
{% endblock %}

{% block content %}
<div class="pd-20 card-box mb-30">
	<div class="clearfix">
		<div class="pull-left">
			<h4 class="text-blue h4">
				<i class="bi bi-exclamation-circle" style="margin-right: 8px;"></i>
				Minor Cases Management
			</h4>
		</div>
		<div class="pull-right">
			<button class="btn btn-primary" data-toggle="modal" data-target="#addCaseModal">
				<i class="bi bi-plus-circle" style="margin-right: 5px;"></i>Add Minor Case
			</button>
		</div>
	</div>
	
	
	<div class="table-responsive">
		<table id="casesTable" class="table table-striped table-bordered" style="width:100%">
			<thead>
				<tr>
					<th>Student Name</th>
					<th>Program</th>
					<th>Section</th>
					<th>Date</th>
					<th>Remarks</th>
					<th>Created</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody>
				{% for case in cases %}
				<tr>
					<td>{{ case.first_name }} {{ case.last_name }}</td>
					<td>{{ case.program }}</td>
					<td>{{ case.section }}</td>
					<td>{{ case.date.strftime('%Y-%m-%d') }}</td>
					<td>{{ case.remarks[:50] }}{% if case.remarks and case.remarks|length > 50 %}...{% endif %}</td>
					<td>{{ case.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
					<td>
						<button class="btn btn-sm btn-outline-primary" data-toggle="modal" data-target="#editModal-{{ case.id }}" title="Edit">
							<i class="bi bi-pencil"></i>
						</button>
						<button class="btn btn-sm btn-outline-danger" data-toggle="modal" data-target="#deleteModal-{{ case.id }}" title="Delete">
							<i class="bi bi-trash"></i>
						</button>
					</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
</div>

<!-- Add Case Modal -->
<div class="modal fade" id="addCaseModal" tabindex="-1" role="dialog" aria-labelledby="addCaseModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="addCaseModalLabel">
					<i class="bi bi-plus-circle" style="margin-right: 8px;"></i>Add New Minor Case
				</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<form method="POST" action="{{ url_for('cases.add_minor_case') }}">
                <!-- CSRF Protection -->
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
									<div class="modal-body">
					<div class="row">
						<div class="col-md-6">
							<div class="form-group">
								<label for="last_name">Last Name <span class="text-danger">*</span></label>
								<input type="text" class="form-control" id="last_name" name="last_name" required maxlength="100">
							</div>
						</div>
						<div class="col-md-6">
							<div class="form-group">
								<label for="first_name">First Name <span class="text-danger">*</span></label>
								<input type="text" class="form-control" id="first_name" name="first_name" required maxlength="100">
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-md-6">
							<div class="form-group">
								<label for="program">Program <span class="text-danger">*</span></label>
								<input type="text" class="form-control" id="program" name="program" required maxlength="100">
							</div>
						</div>
						<div class="col-md-6">
							<div class="form-group">
								<label for="section">Section <span class="text-danger">*</span></label>
								<input type="text" class="form-control" id="section" name="section" required maxlength="50">
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-md-6">
							<div class="form-group">
								<label for="date">Date <span class="text-danger">*</span></label>
								<input type="date" class="form-control" id="date" name="date" required>
							</div>
						</div>
						<div class="col-md-6">
							<div class="form-group">
								<label for="ocr_extract">Quick Fill Options</label>
								<div class="btn-group" role="group">
									<button type="button" class="btn btn-outline-info" id="ocrExtractBtn">
										<i class="bi bi-camera" style="margin-right: 5px;"></i>OCR Extract
									</button>
									<button type="button" class="btn btn-outline-secondary" id="clearFormBtn">
										<i class="bi bi-arrow-clockwise" style="margin-right: 5px;"></i>Clear
									</button>
								</div>
							</div>
						</div>
					</div>
					<div class="form-group">
						<label for="remarks">Remarks</label>
						<textarea class="form-control" id="remarks" name="remarks" rows="3" maxlength="500"></textarea>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-primary">
						<i class="bi bi-check-circle" style="margin-right: 5px;"></i>Add Case
					</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Edit Case Modals -->
{% for case in cases %}
<div class="modal fade" id="editModal-{{ case.id }}" tabindex="-1" role="dialog" aria-labelledby="editModalLabel-{{ case.id }}" aria-hidden="true">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="editModalLabel-{{ case.id }}">
					<i class="bi bi-pencil" style="margin-right: 8px;"></i>Edit Minor Case
				</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<form method="POST" action="{{ url_for('cases.edit_minor_case', case_id=case.id) }}">
                <!-- CSRF Protection -->
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
									<div class="modal-body">
					<div class="row">
						<div class="col-md-6">
							<div class="form-group">
								<label for="edit_last_name_{{ case.id }}">Last Name <span class="text-danger">*</span></label>
								<input type="text" class="form-control" id="edit_last_name_{{ case.id }}" name="last_name" value="{{ case.last_name }}" required maxlength="100">
							</div>
						</div>
						<div class="col-md-6">
							<div class="form-group">
								<label for="edit_first_name_{{ case.id }}">First Name <span class="text-danger">*</span></label>
								<input type="text" class="form-control" id="edit_first_name_{{ case.id }}" name="first_name" value="{{ case.first_name }}" required maxlength="100">
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-md-6">
							<div class="form-group">
								<label for="edit_program_{{ case.id }}">Program <span class="text-danger">*</span></label>
								<input type="text" class="form-control" id="edit_program_{{ case.id }}" name="program" value="{{ case.program }}" required maxlength="100">
							</div>
						</div>
						<div class="col-md-6">
							<div class="form-group">
								<label for="edit_section_{{ case.id }}">Section <span class="text-danger">*</span></label>
								<input type="text" class="form-control" id="edit_section_{{ case.id }}" name="section" value="{{ case.section }}" required maxlength="50">
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-md-6">
							<div class="form-group">
								<label for="edit_date_{{ case.id }}">Date <span class="text-danger">*</span></label>
								<input type="date" class="form-control" id="edit_date_{{ case.id }}" name="date" value="{{ case.date.strftime('%Y-%m-%d') }}" required>
							</div>
						</div>
						<div class="col-md-6">
							<div class="form-group">
								<label>&nbsp;</label>
								<div class="btn-group" role="group">
									<button type="button" class="btn btn-outline-info" onclick="extractOCRForEdit(this)" data-case-id="{{ case.id }}">
										<i class="bi bi-camera" style="margin-right: 5px;"></i>OCR Extract
									</button>
								</div>
							</div>
						</div>
					</div>
					<div class="form-group">
						<label for="edit_remarks_{{ case.id }}">Remarks</label>
						<textarea class="form-control" id="edit_remarks_{{ case.id }}" name="remarks" rows="3" maxlength="500">{{ case.remarks or '' }}</textarea>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-primary">
						<i class="bi bi-check-circle" style="margin-right: 5px;"></i>Update Case
					</button>
				</div>
			</form>
		</div>
	</div>
</div>
{% endfor %}

<!-- Delete Case Modals -->
{% for case in cases %}
<div class="modal fade" id="deleteModal-{{ case.id }}" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel-{{ case.id }}" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="deleteModalLabel-{{ case.id }}">
					<i class="bi bi-exclamation-triangle text-danger" style="margin-right: 8px;"></i>Confirm Delete
				</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<p>Are you sure you want to delete this minor case?</p>
				<div class="alert alert-warning">
					<strong>Student:</strong> {{ case.first_name }} {{ case.last_name }}<br>
					<strong>Program:</strong> {{ case.program }} {{ case.section }}<br>
					<strong>Date:</strong> {{ case.date.strftime('%Y-%m-%d') }}
				</div>
				<p class="text-danger"><strong>This action cannot be undone!</strong></p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
				<form method="POST" action="{{ url_for('cases.delete_minor_case', case_id=case.id) }}" style="display: inline;">
                <!-- CSRF Protection -->
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
										<button type="submit" class="btn btn-danger">
						<i class="bi bi-trash" style="margin-right: 5px;"></i>Delete Case
					</button>
				</form>
			</div>
		</div>
	</div>
</div>
{% endfor %}
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script src="{{ url_for('static', filename='plugins/datatables/js/jquery.dataTables.min.js') }}"></script>
<script src="{{ url_for('static', filename='plugins/datatables/js/dataTables.bootstrap4.min.js') }}"></script>
<script src="{{ url_for('static', filename='plugins/datatables/js/dataTables.responsive.min.js') }}"></script>
<script src="{{ url_for('static', filename='plugins/datatables/js/responsive.bootstrap4.min.js') }}"></script>

<script>
$(document).ready(function() {
	$('#casesTable').DataTable({
		"responsive": true,
		"pageLength": 25,
		"order": [[ 6, "desc" ]], // Sort by created date descending (LIFO)
		"columnDefs": [
			{ "orderable": false, "targets": 7 } // Disable sorting on Actions column
		],
		"language": {
			"search": "Search cases:",
			"lengthMenu": "Show _MENU_ cases per page",
			"info": "Showing _START_ to _END_ of _TOTAL_ cases",
			"infoEmpty": "No cases available",
			"infoFiltered": "(filtered from _MAX_ total cases)"
		}
	});
	
	// Set today's date as default for new cases
	document.getElementById('date').value = new Date().toISOString().split('T')[0];
	
	// OCR Extract functionality
	$('#ocrExtractBtn').click(function() {
		$.post('{{ url_for("cases.minor_ocr_extract") }}', function(data) {
			$('#last_name').val(data.last_name);
			$('#first_name').val(data.first_name);
			$('#program').val(data.program);
			$('#section').val(data.section);
			$('#date').val(data.date);
			$('#remarks').val(data.remarks);
		}).fail(function() {
			alert('OCR extraction failed. Please try again.');
		});
	});
	
	// Clear form functionality
	$('#clearFormBtn').click(function() {
		$('#addCaseModal form')[0].reset();
		document.getElementById('date').value = new Date().toISOString().split('T')[0];
	});
});

// OCR Extract for edit modals
function extractOCRForEdit(button) {
	var caseId = $(button).data('case-id');
	$.post('{{ url_for("cases.minor_ocr_extract") }}', function(data) {
		$('#edit_last_name_' + caseId).val(data.last_name);
		$('#edit_first_name_' + caseId).val(data.first_name);
		$('#edit_program_' + caseId).val(data.program);
		$('#edit_section_' + caseId).val(data.section);
		$('#edit_date_' + caseId).val(data.date);
		$('#edit_remarks_' + caseId).val(data.remarks);
	}).fail(function() {
		alert('OCR extraction failed. Please try again.');
	});
}
</script>
{% endblock %}
