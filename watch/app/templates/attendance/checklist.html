{% extends "base.html" %}

{% block title %}Attendance Checklist - WATCH{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        background: #007BA7;
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
    }
    
    .page-header h1 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 600;
    }
    
    .page-header p {
        margin: 5px 0 0 0;
        opacity: 0.9;
        font-size: 1rem;
    }
    
    .attendance-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 20px;
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .attendance-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .attendance-header {
        padding: 20px;
        border-bottom: 1px solid #f1f3f4;
    }
    
    .faculty-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .faculty-details h4 {
        margin: 0;
        color: #1b00ff;
        font-size: 1.2rem;
        font-weight: 600;
    }
    
    .faculty-details p {
        margin: 4px 0 0 0;
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .status-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-present {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-absent {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .status-late {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .attendance-body {
        padding: 20px;
    }
    
    .schedule-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .info-item {
        text-align: center;
    }
    
    .info-label {
        font-size: 0.8rem;
        color: #6c757d;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 5px;
    }
    
    .info-value {
        font-size: 1rem;
        color: #495057;
        font-weight: 500;
    }
    
    .action-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .btn-mark {
        padding: 10px 20px;
        border-radius: 6px;
        border: none;
        font-weight: 600;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .btn-present {
        background: #28a745;
        color: white;
    }
    
    .btn-present:hover {
        background: #218838;
        color: white;
        transform: translateY(-1px);
    }
    
    .btn-absent {
        background: #dc3545;
        color: white;
    }
    
    .btn-absent:hover {
        background: #c82333;
        color: white;
        transform: translateY(-1px);
    }
    
    .btn-late {
        background: #ffc107;
        color: #212529;
    }
    
    .btn-late:hover {
        background: #e0a800;
        color: #212529;
        transform: translateY(-1px);
    }
    
    /* Marked attendance card styling */
    .attendance-card.marked {
        border-left: 4px solid #28a745;
        background-color: #f8f9fa;
    }
    
    .attendance-card.marked .status-badge {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Spinner animation for loading state */
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.1em;
    }
    
    .date-selector {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
    }
    
    .date-selector h5 {
        margin: 0 0 15px 0;
        color: #495057;
        font-weight: 600;
    }
    
    .badge.bg-primary {
        background-color: #007BA7 !important;
    }
    
    @media (max-width: 768px) {
        .faculty-info {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .schedule-info {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .btn-mark {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="bi bi-check2-square" style="margin-right: 10px;"></i>Attendance Checklist</h1>
    <p>Check and mark faculty attendance based on scheduled classes</p>
</div>

<div class="date-selector">
    <h5><i class="bi bi-calendar3" style="margin-right: 8px;"></i>Today's Schedule</h5>
    <div class="row align-items-center">
        <div class="col-md-6">
            <div class="alert alert-info" style="margin-bottom: 0;">
                <i class="bi bi-calendar-check" style="margin-right: 8px;"></i>
                <strong>{{ today_weekday }}</strong> - {{ date.strftime('%B %d, %Y') if date else 'Today' }}
            </div>
        </div>
        <div class="col-md-6 text-right">
            <span class="badge bg-primary" style="font-size: 0.9rem;">
                {{ schedules|length }} class{{ 'es' if schedules|length != 1 else '' }} scheduled
            </span>
        </div>
    </div>
</div>

{% if schedules and schedules|length > 0 %}
    {% for schedule in schedules %}
    <div class="attendance-card" data-schedule-id="{{ schedule.id }}" data-professor-name="{{ schedule.professor_name }}">
        <div class="attendance-header">
            <div class="faculty-info">
                <div class="faculty-details">
                    <h4>{{ schedule.faculty_name }}</h4>
                    <p>{{ schedule.subject }}</p>
                </div>
                <div class="status-badge status-{{ schedule.status.lower() }}">
                    {% if schedule.status == 'Present' %}
                        <i class="bi bi-check-circle" style="margin-right: 5px;"></i>
                    {% elif schedule.status == 'Absent' %}
                        <i class="bi bi-x-circle" style="margin-right: 5px;"></i>
                    {% elif schedule.status == 'Late' %}
                        <i class="bi bi-clock" style="margin-right: 5px;"></i>
                    {% endif %}
                    {{ schedule.status }}
                </div>
            </div>
        </div>
        <div class="attendance-body">
            <div class="schedule-info">
                <div class="info-item">
                    <div class="info-label">Time Slot</div>
                    <div class="info-value">{{ schedule.time_slot }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Room</div>
                    <div class="info-value">{{ schedule.room }}</div>
                </div>
            </div>
            <div class="action-buttons">
                {% if schedule.status == 'Not Marked' %}
                    <button class="btn btn-mark btn-present" onclick="markAttendance('{{ schedule.id }}', 'present')">
                        <i class="bi bi-check-circle" style="margin-right: 5px;"></i>Mark Present
                    </button>
                    <button class="btn btn-mark btn-late" onclick="markAttendance('{{ schedule.id }}', 'late')">
                        <i class="bi bi-clock" style="margin-right: 5px;"></i>Mark Late
                    </button>
                    <button class="btn btn-mark btn-absent" onclick="markAttendance('{{ schedule.id }}', 'absent')">
                        <i class="bi bi-x-circle" style="margin-right: 5px;"></i>Mark Absent
                    </button>
                {% else %}
                    <div class="alert alert-info text-center" style="margin: 0; padding: 15px;">
                        <i class="bi bi-info-circle" style="margin-right: 8px;"></i>
                        <strong>Attendance Already Marked</strong><br>
                        <small>Status: {{ schedule.status }} - Use History section to edit if needed</small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
{% else %}
<div class="card-box height-100-p pd-20">
    <div class="text-center" style="padding: 60px 20px; color: #6c757d;">
        <i class="bi bi-calendar-x" style="font-size: 4rem; color: #dee2e6; margin-bottom: 20px;"></i>
        <h4>No Scheduled Classes</h4>
        <p>No faculty schedules found for the selected date. Please check the schedule management section.</p>
        <a href="{{ url_for('attendance.schedule_management') }}" class="btn btn-primary" style="margin-top: 15px;">
            <i class="bi bi-calendar-plus" style="margin-right: 8px;"></i>
            Manage Schedules
        </a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Notification function
function showNotification(message, type) {
    const notification = document.createElement('div');
    let alertClass = 'alert-success';
    let icon = 'check-circle';
    
    if (type === 'error') {
        alertClass = 'alert-danger';
        icon = 'exclamation-triangle';
    } else if (type === 'warning') {
        alertClass = 'alert-warning';
        icon = 'exclamation-triangle';
    } else if (type === 'info') {
        alertClass = 'alert-info';
        icon = 'info-circle';
    }
    
    notification.className = `alert ${alertClass} auto-hide`;
    notification.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 9999; max-width: 400px;';
    notification.innerHTML = `
        <i class="bi bi-${icon}" style="margin-right: 8px;"></i>
        ${message}
    `;
    
    document.body.appendChild(notification);
    
    // Auto-hide after 4 seconds (longer for warnings)
    const hideDelay = type === 'warning' ? 4000 : 3000;
    setTimeout(() => {
        notification.style.transition = 'opacity 0.5s';
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 500);
    }, hideDelay);
}

function markAttendance(scheduleId, status) {
    const statusText = status.charAt(0).toUpperCase() + status.slice(1);
    
    // Find the card and check if already marked
    const card = document.querySelector(`[data-schedule-id="${scheduleId}"]`);
    const statusBadge = card.querySelector('.status-badge');
    const currentStatus = statusBadge.textContent.trim();
    
    // Prevent marking if already marked
    if (currentStatus !== 'Not Marked' && currentStatus !== '') {
        showNotification('This faculty attendance has already been marked. Use the History section to edit if needed.', 'warning');
        return;
    }
    
    if (confirm(`Mark this faculty as ${statusText}?`)) {
        const professorName = card.dataset.professorName;
        
        if (!professorName || professorName === 'None') {
            showNotification('Error: Professor name not found. Please refresh the page and try again.', 'error');
            console.error('Professor name is null or undefined for schedule:', scheduleId);
            return;
        }
        
        // Create form data
        const formData = new FormData();
        formData.append('professor_name', professorName);
        formData.append('status', statusText);
        
        // Show loading state on all buttons
        const buttons = card.querySelectorAll('.btn-mark');
        buttons.forEach(btn => {
            btn.disabled = true;
            btn.innerHTML = '<i class="spinner-border spinner-border-sm" style="margin-right: 5px;"></i>Processing...';
        });
        
        // Send AJAX request to update attendance
        fetch('{{ url_for("attendance.update_attendance") }}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the status badge
                statusBadge.className = `status-badge status-${status}`;
                statusBadge.innerHTML = `<i class="bi bi-${status === 'present' ? 'check-circle' : status === 'absent' ? 'x-circle' : 'clock'}" style="margin-right: 5px;"></i>${statusText}`;
                
                // Replace action buttons with "Already Marked" message
                const actionButtons = card.querySelector('.action-buttons');
                actionButtons.innerHTML = `
                    <div class="alert alert-info text-center" style="margin: 0; padding: 15px;">
                        <i class="bi bi-info-circle" style="margin-right: 8px;"></i>
                        <strong>Attendance Already Marked</strong><br>
                        <small>Status: ${statusText} - Use History section to edit if needed</small>
                    </div>
                `;
                
                // Add a subtle animation
                card.style.transform = 'scale(0.98)';
                setTimeout(() => {
                    card.style.transform = 'scale(1)';
                }, 150);
                
                // Show success message
                showNotification(`Success! ${data.message}`, 'success');
                
                // Add a "marked" indicator to the card
                card.classList.add('marked');
                
            } else {
                showNotification(`Error: ${data.message}`, 'error');
                // Re-enable buttons on error and restore original text
                buttons.forEach(btn => {
                    btn.disabled = false;
                    // Restore original button text based on button class
                    if (btn.classList.contains('btn-present')) {
                        btn.innerHTML = '<i class="bi bi-check-circle" style="margin-right: 5px;"></i>Mark Present';
                    } else if (btn.classList.contains('btn-late')) {
                        btn.innerHTML = '<i class="bi bi-clock" style="margin-right: 5px;"></i>Mark Late';
                    } else if (btn.classList.contains('btn-absent')) {
                        btn.innerHTML = '<i class="bi bi-x-circle" style="margin-right: 5px;"></i>Mark Absent';
                    }
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred while updating attendance.', 'error');
            // Re-enable buttons on error and restore original text
            buttons.forEach(btn => {
                btn.disabled = false;
                // Restore original button text based on button class
                if (btn.classList.contains('btn-present')) {
                    btn.innerHTML = '<i class="bi bi-check-circle" style="margin-right: 5px;"></i>Mark Present';
                } else if (btn.classList.contains('btn-late')) {
                    btn.innerHTML = '<i class="bi bi-clock" style="margin-right: 5px;"></i>Mark Late';
                } else if (btn.classList.contains('btn-absent')) {
                    btn.innerHTML = '<i class="bi bi-x-circle" style="margin-right: 5px;"></i>Mark Absent';
                }
            });
        });
    }
}

// Initialize date picker with today's date
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('attendance-date');
    if (dateInput) {
        const today = new Date().toISOString().split('T')[0];
        if (!dateInput.value) {
            dateInput.value = today;
        }
    }
});
</script>
{% endblock %}
