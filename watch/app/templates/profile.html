{% extends "base.html" %}

{% block title %}Profile - WATCH{% endblock %}

{% block extra_css %}
<style>
    .profile-container {
        padding: 20px 0;
    }
    
    .profile-left-card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        padding: 30px;
        margin-bottom: 30px;
        text-align: center;
    }
    
    .profile-picture-container {
        position: relative;
        display: inline-block;
        margin-bottom: 20px;
    }
    
    .profile-picture {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #f8f9fa;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .profile-picture-default {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        color: white;
        font-weight: bold;
        border: 4px solid #f8f9fa;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .profile-edit-icon {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background: #1b00ff;
        color: white;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(27, 0, 255, 0.3);
        transition: all 0.3s ease;
    }
    
    .profile-edit-icon:hover {
        background: #1400cc;
        transform: scale(1.1);
    }
    
    .profile-name {
        font-size: 1.8rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 5px;
    }
    
    .profile-title {
        font-size: 1.1rem;
        color: #667eea;
        font-weight: 500;
        margin-bottom: 5px;
    }
    
    .profile-role {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 25px;
    }
    
    .contact-info {
        text-align: left;
        border-top: 1px solid #e9ecef;
        padding-top: 25px;
    }
    
    .contact-info h5 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
    }
    
    .contact-item {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        padding: 8px 0;
    }
    
    .contact-icon {
        width: 20px;
        color: #667eea;
        margin-right: 12px;
        flex-shrink: 0;
    }
    
    .contact-text {
        color: #495057;
        font-size: 0.95rem;
    }
    
    .profile-right-card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }
    
    .profile-tabs {
        display: flex;
        border-bottom: 1px solid #e9ecef;
        background: #f8f9fa;
    }
    
    .profile-tab {
        flex: 1;
        padding: 15px 20px;
        background: none;
        border: none;
        font-size: 1rem;
        font-weight: 500;
        color: #6c757d;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .profile-tab.active {
        background: #fff;
        color: #1b00ff;
        border-bottom: 3px solid #1b00ff;
    }
    
    .profile-tab:hover:not(.active) {
        background: #e9ecef;
        color: #495057;
    }
    
    .tab-content {
        display: none;
        padding: 30px;
    }
    
    .tab-content.active {
        display: block;
    }
    
    /* Timeline Styles */
    .timeline-container {
        position: relative;
    }
    
    .timeline-item {
        position: relative;
        padding-left: 50px;
        margin-bottom: 25px;
        animation: slideInFromLeft 0.3s ease-out;
    }
    
    .timeline-item:last-child {
        margin-bottom: 0;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: 20px;
        top: 0;
        bottom: -25px;
        width: 2px;
        background: #e9ecef;
    }
    
    .timeline-item:last-child::before {
        display: none;
    }
    
    .timeline-icon {
        position: absolute;
        left: 10px;
        top: 0;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: white;
        z-index: 1;
    }
    
    .timeline-icon.login { background: #28a745; }
    .timeline-icon.logout { background: #6c757d; }
    .timeline-icon.case { background: #dc3545; }
    .timeline-icon.schedule { background: #17a2b8; }
    .timeline-icon.profile { background: #667eea; }
    .timeline-icon.default { background: #6c757d; }
    
    .timeline-content {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        border-left: 3px solid #667eea;
    }
    
    .timeline-time {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 5px;
    }
    
    .timeline-action {
        font-weight: 600;
        color: #333;
        font-size: 0.95rem;
        margin-bottom: 5px;
    }
    
    .timeline-description {
        color: #495057;
        font-size: 0.9rem;
        line-height: 1.4;
        margin: 0;
    }
    
    .timeline-empty {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
        font-style: italic;
    }
    
    /* Settings Form Styles */
    .settings-form .form-group {
        margin-bottom: 20px;
    }
    
    .settings-form label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
        font-size: 0.9rem;
    }
    
    .settings-form .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.95rem;
        transition: border-color 0.3s, box-shadow 0.3s;
    }
    
    .settings-form .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .settings-form textarea.form-control {
        min-height: 80px;
        resize: vertical;
    }
    
    .form-row {
        display: flex;
        gap: 20px;
    }
    
    .form-row .form-group {
        flex: 1;
    }
    
    .btn-save-changes {
        background: #1b00ff;
        border: none;
        padding: 12px 30px;
        border-radius: 6px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s;
        font-size: 0.95rem;
    }
    
    .btn-save-changes:hover {
        background: #1400cc;
    }
    
    .btn-save-changes:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    
    /* Flash Messages */
    .flash-messages {
        margin-bottom: 20px;
    }
    
    .flash-messages .alert {
        margin-bottom: 10px;
        padding: 12px 20px;
        border-radius: 6px;
        font-weight: 500;
    }
    
    .flash-messages .alert i {
        margin-right: 8px;
    }
    
    /* File Upload Styles */
    #profilePictureInput {
        display: none;
    }
    
    /* Animations */
    @keyframes slideInFromLeft {
        from {
            opacity: 0;
            transform: translateX(-30px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    /* Flash Messages */
    .flash-messages {
        margin-bottom: 20px;
    }
    
    .alert {
        padding: 12px 20px;
        border-radius: 6px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }
    
    .alert i {
        margin-right: 10px;
    }
    
    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .alert-danger {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    /* Responsive Design */
    @media (max-width: 767px) {
        .form-row {
            flex-direction: column;
            gap: 0;
        }
        
        .profile-container {
            padding: 10px 0;
        }
        
        .profile-left-card,
        .profile-right-card {
            margin-bottom: 20px;
        }
        
        .tab-content {
            padding: 20px 15px;
        }
        
        .timeline-item {
            padding-left: 40px;
        }
        
        .timeline-item::before {
            left: 15px;
        }
        
        .timeline-icon {
            left: 5px;
        }
    }
</style>
{% endblock %}

{% block content %}

<div class="page-header">
    <div class="row">
        <div class="col-md-6 col-sm-12">
            <div class="title">
                <h4>Profile</h4>
            </div>
            <nav aria-label="breadcrumb" role="navigation">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('core.dashboard') }}">Home</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        Profile
                    </li>
                </ol>
            </nav>
        </div>
    </div>
</div>

<div class="profile-container">
    <div class="row">
        <!-- Left Column: Profile Picture & Contact Info -->
        <div class="col-xl-4 col-lg-4 col-md-5 col-sm-12">
            <div class="profile-left-card">
                <!-- Profile Picture Section -->
                <div class="profile-picture-container">
                    {% if user.profile_picture %}
                        <img src="{{ url_for('static', filename='uploads/profiles/' + user.profile_picture) }}" 
                             alt="Profile Picture" class="profile-picture" id="profileImage">
                    {% else %}
                        <div class="profile-picture-default" id="profileImage">
                            {{ (user.full_name or user.username)[0].upper() if user.full_name or user.username else 'U' }}
                        </div>
                    {% endif %}
                    <div class="profile-edit-icon" onclick="document.getElementById('profilePictureInput').click()">
                        <i class="fa fa-pencil"></i>
                    </div>
                    <input type="file" id="profilePictureInput" accept="image/*" onchange="uploadProfilePicture(this)">
                </div>
                
                <!-- User Info -->
                <div class="profile-name">{{ user.full_name or user.username }}</div>
                <div class="profile-title">{{ user.title or 'No title set' }}</div>
                <div class="profile-role">{{ user.role.name if user.role else 'No role assigned' }}</div>
                
                <!-- Contact Information -->
                <div class="contact-info">
                    <h5>Contact Information</h5>
                    
                    <div class="contact-item">
                        <i class="fa fa-envelope contact-icon"></i>
                        <span class="contact-text">No email set</span>
                    </div>
                    
                    <div class="contact-item">
                        <i class="fa fa-phone contact-icon"></i>
                        <span class="contact-text">{{ user.phone or 'No phone set' }}</span>
                    </div>
                    
                </div>
            </div>
        </div>
        
        <!-- Right Column: Timeline & Settings -->
        <div class="col-xl-8 col-lg-8 col-md-7 col-sm-12">
            <div class="profile-right-card">
                <!-- Tab Navigation -->
                <div class="profile-tabs">
                    <button class="profile-tab active" onclick="switchTab('timeline')">
                        <i class="fa fa-clock-o"></i> Timeline
                    </button>
                    <button class="profile-tab" onclick="switchTab('settings')">
                        <i class="fa fa-cog"></i> Settings
                    </button>
                </div>
                
                <!-- Timeline Tab Content -->
                <div id="timeline-content" class="tab-content active">
                    <div class="timeline-container">
                        {% if activity_logs %}
                            {% for log in activity_logs %}
                            <div class="timeline-item">
                                <div class="timeline-icon {{ log.action.lower() }}">
                                    <i class="fa fa-{{ 'sign-in' if log.action.lower() == 'login' else 'sign-out' if log.action.lower() == 'logout' else 'folder' if 'case' in log.action.lower() else 'calendar' if 'schedule' in log.action.lower() else 'user' if 'profile' in log.action.lower() else 'circle' }}"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="timeline-time">{{ log.timestamp.strftime('%B %d, %Y at %I:%M %p') }}</div>
                                    <div class="timeline-action">{{ log.action }}</div>
                                    <p class="timeline-description">{{ log.description }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="timeline-empty">
                                <i class="fa fa-clock-o" style="font-size: 3rem; color: #dee2e6; margin-bottom: 15px;"></i>
                                <p>No recent activity found</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Settings Tab Content -->
                <div id="settings-content" class="tab-content">
                    <form class="settings-form" id="profileSettingsForm">
                        <!-- CSRF Protection -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fullName">Full Name</label>
                                <input type="text" class="form-control" id="fullName" name="full_name" 
                                       value="{{ user.full_name or '' }}" placeholder="Enter your full name">
                            </div>
                            <div class="form-group">
                                <label for="title">Title</label>
                                <input type="text" class="form-control" id="title" name="title" 
                                       value="{{ user.title or '' }}" placeholder="Enter your title">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="email">Email Address</label>
                                <input type="email" class="form-control" id="email" name="email" 
                                       value="" placeholder="Configure email below to display here" readonly>
                                <small class="form-text text-muted">This field shows the email address configured in Email Configuration below</small>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone Number</label>
                                <input type="tel" class="form-control" id="phone" name="phone" 
                                       value="{{ user.phone or '' }}" placeholder="Enter your phone number"
                                       minlength="7" maxlength="20" pattern="[\d\s\-\(\)\+]{7,20}">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="gender">Gender</label>
                                <select class="form-control" id="gender" name="gender">
                                    <option value="">Select Gender</option>
                                    <option value="Male" {{ 'selected' if user.gender == 'Male' else '' }}>Male</option>
                                    <option value="Female" {{ 'selected' if user.gender == 'Female' else '' }}>Female</option>
                                    <option value="Other" {{ 'selected' if user.gender == 'Other' else '' }}>Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <!-- Empty div to maintain form layout -->
                            </div>
                        </div>
                        
                        <hr style="margin: 30px 0; border-color: #e9ecef;">
                        
                        <!-- Email Configuration Section -->
                        <div class="email-config-section">
                            <h5 style="color: #28a745; margin-bottom: 20px;">
                                <i class="fa fa-envelope" style="margin-right: 8px;"></i>
                                Email Configuration
                            </h5>
                            <p class="text-muted" style="margin-bottom: 25px;">Configure email settings for sending appointment notifications</p>
                            
                            <!-- Email Settings Form (nested within main form) -->
                            <div id="emailSettingsForm">
                                <!-- Auto-enable email when configured -->
                                <input type="hidden" name="enabled" value="true">
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="font-weight-bold">
                                            <i class="fa fa-cloud" style="margin-right: 5px; color: #28a745;"></i>
                                            Email Provider
                                        </label>
                                        <select class="form-control" name="provider" id="emailProvider">
                                            <option value="gmail" {% if email_settings.provider == 'gmail' %}selected{% endif %}>Gmail</option>
                                            <option value="outlook" {% if email_settings.provider == 'outlook' %}selected{% endif %}>Outlook / Microsoft 365</option>
                                        </select>
                                        <small class="form-text text-muted">Choose your email service provider</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="font-weight-bold">
                                            <i class="fa fa-key" style="margin-right: 5px; color: #28a745;"></i>
                                            App Password
                                        </label>
                                        <input type="password" class="form-control" name="sender_password" id="senderPassword" 
                                               placeholder="Enter app password" 
                                               autocomplete="new-password">
                                        <div class="mt-2">
                                            <small class="text-info">
                                                <i class="fa fa-info-circle"></i>
                                                <span id="currentPasswordStatus">
                                                    {% if email_settings.provider == 'gmail' %}
                                                        {% if email_settings.gmail_password %}
                                                            [OK] Gmail password is saved
                                                        {% else %}
                                                            [WARNING] No Gmail password saved
                                                        {% endif %}
                                                    {% elif email_settings.provider == 'outlook' %}
                                                        {% if email_settings.outlook_password %}
                                                            [OK] Outlook password is saved
                                                        {% else %}
                                                            [WARNING] No Outlook password saved
                                                        {% endif %}
                                                    {% endif %}
                                                </span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="font-weight-bold">
                                            <i class="fa fa-envelope" style="margin-right: 5px; color: #28a745;"></i>
                                            Sender Email Address
                                        </label>
                                        <input type="email" class="form-control" name="sender_email" id="senderEmail" 
                                               value="" 
                                               placeholder="your.email@school.edu.ph" 
                                               autocomplete="off">
                                        <small class="form-text text-muted">The email address that will send the notifications</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="font-weight-bold">
                                            <i class="fa fa-user" style="margin-right: 5px; color: #28a745;"></i>
                                            Sender Display Name
                                        </label>
                                        <input type="text" class="form-control" name="sender_name" id="senderName"
                                               value="{{ email_settings.sender_name }}" 
                                               placeholder="Discipline Office"
                                               autocomplete="off">
                                        <small class="form-text text-muted">Name that appears as the email sender</small>
                                    </div>
                                </div>
                                
                                <!-- Instructions moved below all fields -->
                                <div class="mt-3 p-3" style="background-color: #f8f9fa; border-radius: 6px; border-left: 4px solid #28a745;">
                                    <h6 class="font-weight-bold mb-2" style="color: #28a745;">
                                        <i class="fa fa-info-circle" style="margin-right: 5px;"></i>
                                        Setup Instructions
                                    </h6>
                                    <div id="gmailInstructions" {% if email_settings.provider != 'gmail' %}style="display: none;"{% endif %}>
                                        <p class="font-weight-bold mb-2">📧 Gmail Setup:</p>
                                        <ol class="small mb-3" style="line-height: 1.8;">
                                            <li>Go to <a href="https://myaccount.google.com/security" target="_blank">Google Account Security</a></li>
                                            <li>Enable <strong>2-Step Verification</strong></li>
                                            <li>Go to <a href="https://myaccount.google.com/apppasswords" target="_blank">App Passwords</a></li>
                                            <li>Generate password for "Mail"</li>
                                            <li>Copy the 16-character password</li>
                                            <li>Paste it in the "App Password" field above</li>
                                        </ol>
                                    </div>
                                    
                                    <div id="outlookInstructions" {% if email_settings.provider != 'outlook' %}style="display: none;"{% endif %}>
                                        <p class="font-weight-bold mb-2">📨 Outlook Setup:</p>
                                        <ol class="small mb-3" style="line-height: 1.8;">
                                            <li>Go to <a href="https://account.microsoft.com/security" target="_blank">Microsoft Account Security</a></li>
                                            <li>Enable <strong>Two-step verification</strong></li>
                                            <li>Go to <a href="https://account.live.com/proofs/AppPassword" target="_blank">App Passwords</a></li>
                                            <li>Generate a new app password</li>
                                            <li>Copy the password</li>
                                            <li>Paste it in the "App Password" field above</li>
                                        </ol>
                                    </div>
                                    
                                    <div class="alert alert-warning small mb-0">
                                        <i class="fa fa-exclamation-triangle" style="margin-right: 5px;"></i>
                                        <strong>Important:</strong> Use App Password, NOT your regular email password!
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group text-right">
                            <button type="button" class="btn btn-danger" onclick="confirmRemoveEmail()" style="margin-right: 10px;">
                                <i class="fa fa-trash"></i> Remove Email
                            </button>
                            <button type="submit" class="btn-save-changes">
                                <i class="fa fa-save"></i> Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Tab switching functionality
function switchTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.profile-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabName + '-content').classList.add('active');
    
    // Add active class to selected tab
    event.target.closest('.profile-tab').classList.add('active');
}

// Profile picture upload functionality
function uploadProfilePicture(input) {
    if (input.files && input.files[0]) {
        const formData = new FormData();
        formData.append('profile_picture', input.files[0]);
        
        // Show loading state
        const editIcon = document.querySelector('.profile-edit-icon');
        const originalHTML = editIcon.innerHTML;
        editIcon.innerHTML = '<i class="fa fa-upload"></i>';
        
        fetch('{{ url_for("core.upload_profile_picture") }}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update profile image
                const profileImage = document.getElementById('profileImage');
                if (profileImage.tagName === 'IMG') {
                    profileImage.src = data.image_url + '?t=' + new Date().getTime();
                } else {
                    // Replace default avatar with actual image
                    profileImage.outerHTML = `<img src="${data.image_url}?t=${new Date().getTime()}" alt="Profile Picture" class="profile-picture" id="profileImage">`;
                }
                
                // Show success message
                showFlashMessage('Profile picture updated successfully!', 'success');
            } else {
                showFlashMessage(data.error || 'Failed to upload profile picture', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showFlashMessage('An error occurred while uploading the image', 'error');
        })
        .finally(() => {
            // Restore edit icon
            editIcon.innerHTML = originalHTML;
        });
    }
}

// Profile settings form submission
document.getElementById('profileSettingsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('.btn-save-changes');
    const originalText = submitBtn.innerHTML;
    
    // Add email settings data to form data
    const emailProvider = document.getElementById('emailProvider');
    const senderEmail = document.getElementById('senderEmail');
    const senderPassword = document.getElementById('senderPassword');
    const senderName = document.getElementById('senderName');
    
    if (emailProvider) formData.append('provider', emailProvider.value);
    if (senderEmail) formData.append('sender_email', senderEmail.value);
    if (senderPassword) formData.append('sender_password', senderPassword.value);
    if (senderName) formData.append('sender_name', senderName.value);
    formData.append('enabled', 'true'); // Always enabled when configured
    
    // Show loading state
    submitBtn.innerHTML = 'Saving...';
    submitBtn.disabled = true;
    
    // First save profile data
    fetch('{{ url_for("core.update_profile_ajax") }}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update contact info display
            updateContactInfo(data.user);
            
            // Then save email settings
            return fetch('{{ url_for("settings.save_email_settings") }}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                },
                body: formData
            });
        } else {
            throw new Error(data.error || 'Failed to update profile');
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showFlashMessage('Profile and email settings updated successfully!', 'success');
        } else {
            showFlashMessage('Profile updated, but email settings failed: ' + (data.error || 'Unknown error'), 'warning');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showFlashMessage('An error occurred while updating your profile', 'error');
    })
    .finally(() => {
        // Restore button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// Update contact info display
function updateContactInfo(user) {
    const contactItems = document.querySelectorAll('.contact-item .contact-text');
    contactItems[0].textContent = user.email || 'No email set';
    contactItems[1].textContent = user.phone || 'No phone set';
    
    // Update profile name and title
    document.querySelector('.profile-name').textContent = user.full_name || user.username;
    document.querySelector('.profile-title').textContent = user.title || 'No title set';
}

// Show flash messages dynamically
function showFlashMessage(message, type) {
    try {
        const flashContainer = document.querySelector('.flash-messages');
        if (!flashContainer) {
            const container = document.createElement('div');
            container.className = 'flash-messages';
            
            // Find the profile container and insert flash messages at the top
            const profileContainer = document.querySelector('.profile-container');
            if (profileContainer) {
                profileContainer.insertBefore(container, profileContainer.firstChild);
            } else {
                // Fallback: insert at the beginning of body
                document.body.insertBefore(container, document.body.firstChild);
            }
        }
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'error' ? 'danger' : 'success'}`;
        alertDiv.innerHTML = `
            <i class="fa fa-${type === 'error' ? 'exclamation-triangle' : 'check-circle'}"></i>
            ${message}
        `;
        
        const flashMessagesContainer = document.querySelector('.flash-messages');
        if (flashMessagesContainer) {
            flashMessagesContainer.appendChild(alertDiv);
            
            // Remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    } catch (error) {
        console.error('Error showing flash message:', error);
        // Fallback: use browser alert
        alert(message);
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Add form validation
    const form = document.getElementById('profileSettingsForm');
    
    if (!form) {
        return;
    }
    
    const inputs = form.querySelectorAll('input[type="email"]');
    
    inputs.forEach(input => {
        input.addEventListener('blur', function() {
            if (this.value && !this.checkValidity()) {
                this.style.borderColor = '#dc3545';
            } else {
                this.style.borderColor = '#ddd';
            }
        });
    });
    
    // Email Configuration Auto-populate functionality
    const senderEmailInput = document.getElementById('senderEmail');
    const personalEmailInput = document.getElementById('email');
    
    // Update personal email display when sender email changes
    if (senderEmailInput && personalEmailInput) {
        senderEmailInput.addEventListener('input', function() {
            if (this.value && this.value.trim() !== '') {
                personalEmailInput.value = this.value;
                // Trigger change event to update any dependent elements
                personalEmailInput.dispatchEvent(new Event('change'));
            } else {
                // Clear personal email if sender email is cleared
                personalEmailInput.value = '';
            }
        });
    }
    
    // Email provider change handler
    const emailProvider = document.getElementById('emailProvider');
    if (emailProvider) {
        emailProvider.addEventListener('change', function() {
            const provider = this.value;
            
            // Toggle instructions
            const gmailInstructions = document.getElementById('gmailInstructions');
            const outlookInstructions = document.getElementById('outlookInstructions');
            
            if (gmailInstructions && outlookInstructions) {
                gmailInstructions.style.display = provider === 'gmail' ? 'block' : 'none';
                outlookInstructions.style.display = provider === 'outlook' ? 'block' : 'none';
            }
            
            // Update password status
            updatePasswordStatus(provider);
        });
    }
    
    // Function to update password status
    function updatePasswordStatus(provider) {
        const statusElement = document.getElementById('currentPasswordStatus');
        if (statusElement) {
            if (provider === 'gmail') {
                // Check if Gmail password exists (this would need to be passed from backend)
                statusElement.innerHTML = '[WARNING] No Gmail password saved';
            } else if (provider === 'outlook') {
                // Check if Outlook password exists (this would need to be passed from backend)
                statusElement.innerHTML = '[WARNING] No Outlook password saved';
            }
        }
    }
});

// Remove Email functionality
function confirmRemoveEmail() {
    // Show confirmation toast with clear warning about system-wide impact
    showToast('warning', 'SYSTEM-WIDE EMAIL REMOVAL', 'This will remove email configuration for ALL users (Admin & Committee). This action cannot be undone. Are you sure?', function() {
        removeEmailConfiguration();
    });
}

function removeEmailConfiguration() {
    // Clear email fields
    const senderEmailInput = document.getElementById('senderEmail');
    const senderPasswordInput = document.getElementById('senderPassword');
    const senderNameInput = document.getElementById('senderName');
    const emailProviderSelect = document.getElementById('emailProvider');
    
    if (senderEmailInput) senderEmailInput.value = '';
    if (senderPasswordInput) senderPasswordInput.value = '';
    if (senderNameInput) senderNameInput.value = '';
    if (emailProviderSelect) emailProviderSelect.value = 'gmail';
    
    // Show success toast
    showToast('success', 'System Email Configuration Cleared', 'All email settings have been cleared for the entire system. Click "Save Changes" to confirm removal.');
}

// Toast notification function
function showToast(type, title, message, callback = null) {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        `;
        document.body.appendChild(toastContainer);
    }
    
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    toast.style.cssText = `
        background: ${type === 'success' ? '#d4edda' : type === 'warning' ? '#fff3cd' : '#f8d7da'};
        border: 1px solid ${type === 'success' ? '#c3e6cb' : type === 'warning' ? '#ffeaa7' : '#f5c6cb'};
        color: ${type === 'success' ? '#155724' : type === 'warning' ? '#856404' : '#721c24'};
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 6px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        animation: slideInRight 0.3s ease-out;
        position: relative;
        cursor: ${callback ? 'pointer' : 'default'};
    `;
    
    // Add CSS animation
    if (!document.getElementById('toast-animations')) {
        const style = document.createElement('style');
        style.id = 'toast-animations';
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
    
    toast.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <strong>${title}</strong>
                <div style="margin-top: 5px; font-size: 0.9rem;">${message}</div>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" style="
                background: none;
                border: none;
                font-size: 18px;
                cursor: pointer;
                margin-left: 10px;
                color: inherit;
                opacity: 0.7;
            ">&times;</button>
        </div>
    `;
    
    // Add click handler for callback
    if (callback) {
        toast.addEventListener('click', function(e) {
            if (e.target.tagName !== 'BUTTON') {
                callback();
                toast.remove();
            }
        });
    }
    
    // Add to container
    toastContainer.appendChild(toast);
    
    // Auto-remove after 5 seconds if no callback
    if (!callback) {
        setTimeout(() => {
            if (toast.parentElement) {
                toast.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }
        }, 5000);
    }
}

// Form validation to prevent whitespace-only inputs
document.addEventListener('DOMContentLoaded', function() {
    const profileForm = document.getElementById('profileSettingsForm');
    
    if (profileForm) {
        profileForm.addEventListener('submit', function(e) {
            if (!validateProfileForm()) {
                e.preventDefault();
                return false;
            }
        });
    }
    
    // Add real-time validation to text inputs
    const textInputs = [
        'fullName', 'title', 'phone', 
        'senderEmail', 'senderName'
        // Note: 'email' field is read-only and managed through Email Configuration
    ];
    
    textInputs.forEach(inputId => {
        const element = document.getElementById(inputId);
        if (element) {
            element.addEventListener('blur', function() {
                validateTextField(this);
            });
        }
    });
});

function validateProfileForm() {
    const textInputs = [
        { id: 'fullName', name: 'Full Name' },
        { id: 'title', name: 'Title' },
        // Note: 'email' field is read-only and managed through Email Configuration
        { id: 'phone', name: 'Phone' },
        { id: 'senderEmail', name: 'Sender Email' },
        { id: 'senderName', name: 'Sender Name' }
    ];
    
    for (const input of textInputs) {
        const element = document.getElementById(input.id);
        if (element && element.value) {
            const value = element.value.trim();
            
            // Check if value is empty after trimming
            if (!value) {
                alert(`${input.name} cannot be empty or contain only spaces.`);
                element.focus();
                return false;
            }
            
            // Check if value contains only whitespace
            if (/^\s+$/.test(element.value)) {
                alert(`${input.name} cannot contain only whitespace characters.`);
                element.focus();
                return false;
            }
            
            // Update the field with trimmed value
            element.value = value;
            
            // Additional validation for specific fields
            if (input.id === 'senderEmail') {
                if (!isValidEmail(value)) {
                    alert(`${input.name} must be a valid email address.`);
                    element.focus();
                    return false;
                }
            }
            
            if (input.id === 'phone') {
                if (!isValidPhone(value)) {
                    alert(`${input.name} must be a valid phone number (7-12 digits, Philippines format).`);
                    element.focus();
                    return false;
                }
            }
        }
    }
    
    return true;
}

function validateTextField(element) {
    if (element.value && /^\s+$/.test(element.value)) {
        const fieldName = element.previousElementSibling.textContent.replace('*', '').trim();
        alert(`${fieldName} cannot contain only whitespace characters.`);
        element.value = '';
        element.focus();
    } else if (element.value) {
        element.value = element.value.trim();
    }
}

function isValidEmail(email) {
    const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    return emailPattern.test(email);
}

function isValidPhone(phone) {
    const phonePattern = /^[\d\s\-\(\)\+]+$/;
    
    // Check if phone matches valid characters and contains digits
    if (!phonePattern.test(phone) || !/\d/.test(phone)) {
        return false;
    }
    
    // Extract only digits for length validation
    const digitsOnly = phone.replace(/[^\d]/g, '');
    
    // Check length limits (7-12 digits for Philippines format)
    if (digitsOnly.length < 7 || digitsOnly.length > 12) {
        return false;
    }
    
    return true;
}
</script>
{% endblock %}
