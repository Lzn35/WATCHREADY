{% extends "base.html" %}

{% block title %}Discipline Officer Appointments - WATCH{% endblock %}

{% block extra_css %}
<style>
.appointment-card {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

.appointment-card:hover {
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.appointment-header {
    background: linear-gradient(45deg, #007bff, #0056b3);
    color: white;
    padding: 20px;
    border-radius: 10px 10px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.appointment-id {
    font-size: 18px;
    font-weight: bold;
    margin: 0;
}

.status-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    text-transform: uppercase;
}

.status-pending {
    background-color: #ffc107;
    color: #856404;
}

.status-scheduled {
    background-color: #28a745;
    color: white;
}

.status-cancelled {
    background-color: #dc3545;
    color: white;
}

.appointment-body {
    padding: 25px;
}

.appointment-info {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 20px;
}

.info-item {
    display: flex;
    align-items: center;
    flex: 1;
    min-width: 200px;
}

.info-item i {
    font-size: 18px;
    color: #007bff;
    margin-right: 10px;
    width: 20px;
}

.info-label {
    font-weight: 600;
    color: #495057;
    margin-right: 8px;
}

.info-value {
    color: #6c757d;
}

.appointment-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.btn-action {
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-confirm {
    background-color: #28a745;
    color: white;
}

.btn-confirm:hover {
    background-color: #218838;
    transform: translateY(-1px);
}

.btn-reschedule {
    background-color: #ffc107;
    color: #212529;
}

.btn-reschedule:hover {
    background-color: #e0a800;
    transform: translateY(-1px);
}

.btn-cancel {
    background-color: #dc3545;
    color: white;
}

.btn-cancel:hover {
    background-color: #c82333;
    transform: translateY(-1px);
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.empty-state i {
    font-size: 64px;
    color: #dee2e6;
    margin-bottom: 20px;
}

.empty-state h3 {
    color: #495057;
    margin-bottom: 10px;
}

.qr-info {
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    margin-bottom: 30px;
}

.qr-info i {
    font-size: 48px;
    color: #007bff;
    margin-bottom: 15px;
}

.qr-info h5 {
    color: #495057;
    margin-bottom: 10px;
}

.qr-info p {
    color: #6c757d;
    margin: 0;
}

/* Toast notification animations */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

.toast-notification {
    animation: slideInRight 0.3s ease;
}

.toast-notification.fade-out {
    animation: slideOutRight 0.3s ease;
}
</style>
{% endblock %}

{% block content %}
<div class="pd-20 card-box mb-30">
	<div class="clearfix">
		<div class="pull-left">
			<h4 class="text-blue h4">
				<i class="bi bi-calendar-check"></i> Discipline Officer Appointments
			</h4>
		</div>
	</div>

	<div class="qr-info">
		<i class="bi bi-qr-code"></i>
		<h5>QR Code System Active</h5>
		<p>Students can scan the QR code at your office door to schedule appointments. No need for manual scheduling!</p>
	</div>
	
	<!-- Action Buttons moved to bottom left -->
	<div class="action-buttons" style="margin-top: 20px; margin-bottom: 20px;">
		<button class="btn btn-danger" onclick="showDeleteAllModal()" style="margin-right: 10px;">
			<i class="bi bi-trash"></i> Delete All Appointments
		</button>
		<a href="{{ url_for('complaints.qr_generator') }}" class="btn btn-info">
			<i class="bi bi-qr-code"></i> Generate QR Code
		</a>
	</div>
	
	<div id="appointmentsContainer">
		<div class="text-center py-4">
			<i class="bi bi-calendar-x" style="font-size: 24px; color: #6c757d;"></i>
			<p class="text-muted mt-2">No appointments available</p>
		</div>
	</div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" role="dialog">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Confirm Appointment</h5>
				<button type="button" class="close" data-dismiss="modal">
					<span>&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<p>Are you sure you want to confirm this appointment?</p>
				<p class="text-muted">An email confirmation will be sent to the student.</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
				<button type="button" class="btn btn-success" id="confirmAppointmentBtn">Confirm</button>
			</div>
		</div>
	</div>
</div>

<!-- Reschedule Modal -->
<div class="modal fade" id="rescheduleModal" tabindex="-1" role="dialog">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Reschedule Appointment</h5>
				<button type="button" class="close" data-dismiss="modal">
					<span>&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<p><strong>Customize the reschedule notification:</strong></p>
				<p class="text-muted small">Edit the message below to specify your available times for the student.</p>
				
				<div class="form-group">
					<label for="rescheduleMessage"><strong>Message to Student:</strong></label>
					<textarea class="form-control" id="rescheduleMessage" rows="6" placeholder="Enter your message...">I am available for rescheduling on the following dates and times:

- Monday, October 7, 2025 at 2:00 PM
- Tuesday, October 8, 2025 at 10:00 AM  
- Wednesday, October 9, 2025 at 3:00 PM

Please reply to this email or visit the office to confirm your preferred time slot.</textarea>
				</div>
				
				<div class="alert alert-info small mb-0">
					<i class="bi bi-info-circle" style="margin-right: 5px;"></i>
					<strong>Tip:</strong> Specify your available dates and times so the student knows when to reschedule.
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
				<button type="button" class="btn btn-warning" id="rescheduleAppointmentBtn">
					<i class="bi bi-send" style="margin-right: 5px;"></i>Send Reschedule Email
				</button>
			</div>
		</div>
	</div>
</div>

<!-- Delete Appointment Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Delete Appointment</h5>
				<button type="button" class="close" data-dismiss="modal">
					<span>&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<p>Are you sure you want to delete this appointment?</p>
				<p class="text-muted">This action cannot be undone. The appointment will be permanently removed from the system.</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
				<button type="button" class="btn btn-danger" id="deleteAppointmentBtn">Delete</button>
			</div>
		</div>
	</div>
</div>

<!-- Delete All Appointments Modal -->
<div class="modal fade" id="deleteAllModal" tabindex="-1" role="dialog">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Delete All Appointments</h5>
				<button type="button" class="close" data-dismiss="modal">
					<span>&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<p><strong>Warning:</strong> Are you sure you want to delete ALL appointments?</p>
				<p class="text-muted">This action cannot be undone. All appointments will be permanently removed from the system.</p>
				<div class="alert alert-danger" role="alert">
					<i class="bi bi-exclamation-triangle"></i>
					This will delete all pending, scheduled, and cancelled appointments.
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
				<button type="button" class="btn btn-danger" id="deleteAllAppointmentsBtn">Delete All</button>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentAppointmentId = null;

$(document).ready(function() {
    loadAppointments();
    initializeRealTimeUpdates();
});

// Real-time update system
let lastAppointmentCount = 0;

function initializeRealTimeUpdates() {
    // Load initial appointments count
    lastAppointmentCount = 0;
    
    // Set up polling for real-time updates every 2 seconds
    setInterval(function() {
        checkForNewAppointments();
    }, 2000);
}

function checkForNewAppointments() {
    $.ajax({
        url: '/complaints/api/appointments',
        method: 'GET',
        xhrFields: {
            withCredentials: true
        },
        success: function(appointments) {
            const currentCount = appointments.length;
            console.log('Checking appointments - Current:', currentCount, 'Last:', lastAppointmentCount);
            
            // If there are new appointments, reload the page
            if (currentCount > lastAppointmentCount) {
                console.log('New appointments detected!');
                lastAppointmentCount = currentCount;
                loadAppointments();
                
                // Show notification for new appointment
                if (appointments.length > 0) {
                    const latestAppointment = appointments[appointments.length - 1];
                    showToastNotification({
                        title: 'New Appointment Request',
                        message: `${latestAppointment.full_name} requested a ${latestAppointment.appointment_type.toLowerCase()} appointment`,
                        timestamp: latestAppointment.created_at
                    });
                }
            } else if (currentCount < lastAppointmentCount) {
                // If appointments were deleted, update count
                lastAppointmentCount = currentCount;
            }
        },
        error: function(xhr, status, error) {
            console.error('Failed to check for new appointments:', xhr.responseText);
        }
    });
}


function showToastNotification(data) {
    const toastHtml = `
        <div class="toast-notification" style="position: fixed; top: 20px; right: 20px; z-index: 9999; background: #007bff; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 350px; animation: slideInRight 0.3s ease;">
            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                <i class="bi bi-calendar-plus" style="margin-right: 8px; font-size: 18px;"></i>
                <strong>${data.title}</strong>
            </div>
            <div style="font-size: 14px; margin-bottom: 8px;">${data.message}</div>
            <div style="font-size: 12px; opacity: 0.8;">
                <i class="bi bi-clock"></i> ${new Date(data.timestamp).toLocaleString()}
            </div>
            <button onclick="this.parentElement.remove()" style="position: absolute; top: 5px; right: 10px; background: none; border: none; color: white; font-size: 18px; cursor: pointer;">&times;</button>
        </div>
    `;
    
    $('body').append(toastHtml);
    
    // Auto-remove after 5 seconds
    setTimeout(function() {
        $('.toast-notification').fadeOut(300, function() {
            $(this).remove();
        });
    }, 5000);
}


function loadAppointments() {
    console.log('Loading appointments...');
    $.ajax({
        url: '/complaints/api/appointments',
        method: 'GET',
        xhrFields: {
            withCredentials: true
        },
        success: function(appointments) {
            console.log('Appointments loaded:', appointments);
            lastAppointmentCount = appointments.length;
            displayAppointments(appointments);
        },
        error: function(xhr, status, error) {
            console.error('Error loading appointments:', xhr.responseText);
            $('#appointmentsContainer').html(`
                <div class="empty-state">
                    <i class="bi bi-exclamation-triangle"></i>
                    <h3>Error Loading Appointments</h3>
                    <p>Unable to load appointments. Please try again later.</p>
                    <p>Error: ${xhr.responseText}</p>
                    <button class="btn btn-primary" onclick="loadAppointments()">Retry</button>
                </div>
            `);
        }
    });
}

function displayAppointments(appointments) {
    const container = $('#appointmentsContainer');
    
    if (appointments.length === 0) {
        container.html(`
            <div class="empty-state">
                <i class="bi bi-calendar-x"></i>
                <h3>No Appointments</h3>
                <p>No appointment requests have been submitted yet.</p>
                <p class="text-muted">Students can scan the QR code at your office to schedule appointments.</p>
            </div>
        `);
        return;
    }

    let appointmentsHtml = '';
    
    appointments.forEach(function(apt) {
        const statusClass = getStatusClass(apt.status);
        const statusIcon = getStatusIcon(apt.status);
        
        appointmentsHtml += `
            <div class="appointment-card">
                <div class="appointment-header">
                    <h5 class="appointment-id">APT-${String(apt.id).padStart(3, '0')}</h5>
                    <span class="status-badge ${statusClass}">${statusIcon} ${apt.status}</span>
                </div>
                <div class="appointment-body">
                    <div class="appointment-info">
                        <div class="info-item">
                            <i class="bi bi-person"></i>
                            <span class="info-label">Name:</span>
                            <span class="info-value">${apt.full_name}</span>
                        </div>
                        <div class="info-item">
                            <i class="bi bi-calendar"></i>
                            <span class="info-label">Date & Time:</span>
                            <span class="info-value">${apt.appointment_date}</span>
                        </div>
                        <div class="info-item">
                            <i class="bi bi-tag"></i>
                            <span class="info-label">Type:</span>
                            <span class="info-value">${apt.appointment_type}</span>
                        </div>
                        <div class="info-item">
                            <i class="bi bi-envelope"></i>
                            <span class="info-label">Email:</span>
                            <span class="info-value">${apt.email}</span>
                        </div>
                        ${apt.appointment_description ? `
                        <div class="info-item" style="grid-column: 1 / -1;">
                            <i class="bi bi-chat-text"></i>
                            <span class="info-label">Description:</span>
                            <span class="info-value">${apt.appointment_description}</span>
                        </div>
                        ` : ''}
                        <div class="info-item">
                            <i class="bi bi-clock"></i>
                            <span class="info-label">Submitted:</span>
                            <span class="info-value">${apt.created_at}</span>
                        </div>
                    </div>
                    <div class="appointment-actions">
                        ${getActionButtons(apt.status, apt.id)}
                    </div>
                </div>
            </div>
        `;
    });
    
    container.html(appointmentsHtml);
}

function getStatusClass(status) {
    switch(status.toLowerCase()) {
        case 'pending': return 'status-pending';
        case 'scheduled': return 'status-scheduled';
        case 'cancelled': return 'status-cancelled';
        case 'rescheduled': return 'status-cancelled';
        default: return 'status-pending';
    }
}

function getStatusIcon(status) {
    switch(status.toLowerCase()) {
        case 'pending': return '<i class="bi bi-clock"></i>';
        case 'scheduled': return '<i class="bi bi-check-circle"></i>';
        case 'cancelled': return '<i class="bi bi-x-circle"></i>';
        case 'rescheduled': return '<i class="bi bi-arrow-clockwise"></i>';
        default: return '<i class="bi bi-question-circle"></i>';
    }
}

function getActionButtons(status, appointmentId) {
    let buttons = '';
    
    if (status.toLowerCase() === 'pending') {
        buttons += `
            <button class="btn-action btn-confirm" onclick="showConfirmModal(${appointmentId})">
                <i class="bi bi-check-circle"></i> Confirm
            </button>
            <button class="btn-action btn-reschedule" onclick="showRescheduleModal(${appointmentId})">
                <i class="bi bi-arrow-clockwise"></i> Reschedule
            </button>
        `;
    } else if (status.toLowerCase() === 'scheduled') {
        buttons += `
            <button class="btn-action btn-reschedule" onclick="showRescheduleModal(${appointmentId})">
                <i class="bi bi-arrow-clockwise"></i> Reschedule
            </button>
        `;
    }
    
    // Add delete button for all statuses
    buttons += `
        <button class="btn-action btn-cancel" onclick="showDeleteModal(${appointmentId})" title="Delete Appointment">
            <i class="bi bi-trash"></i> Delete
        </button>
    `;
    
    return buttons;
}

function showConfirmModal(appointmentId) {
    currentAppointmentId = appointmentId;
    $('#confirmModal').modal('show');
}

function showRescheduleModal(appointmentId) {
    currentAppointmentId = appointmentId;
    $('#rescheduleModal').modal('show');
}

function showDeleteModal(appointmentId) {
    currentAppointmentId = appointmentId;
    $('#deleteModal').modal('show');
}

function showDeleteAllModal() {
    $('#deleteAllModal').modal('show');
}

$('#confirmAppointmentBtn').click(function() {
    if (currentAppointmentId) {
        confirmAppointment(currentAppointmentId);
    }
});

$('#rescheduleAppointmentBtn').click(function() {
    if (currentAppointmentId) {
        rescheduleAppointment(currentAppointmentId);
    }
});

$('#deleteAppointmentBtn').click(function() {
    if (currentAppointmentId) {
        deleteAppointment(currentAppointmentId);
    }
});

$('#deleteAllAppointmentsBtn').click(function() {
    deleteAllAppointments();
});

function confirmAppointment(appointmentId) {
    $.ajax({
        url: `/complaints/appointments/${appointmentId}/confirm`,
        method: 'PUT',
        success: function(response) {
            $('#confirmModal').modal('hide');
            showAlert('Appointment confirmed successfully! Email notification sent to student.', 'success');
            loadAppointments();
        },
        error: function(xhr) {
            const errorMessage = xhr.responseJSON?.error || 'Error confirming appointment';
            showAlert(errorMessage, 'danger');
        }
    });
}

function rescheduleAppointment(appointmentId) {
    // Get custom message from textarea
    const customMessage = $('#rescheduleMessage').val().trim();
    
    // Validate message
    if (!customMessage) {
        showNotification('Please enter a message with your available times.', 'warning');
        return;
    }
    
    $.ajax({
        url: `/complaints/appointments/${appointmentId}/reschedule`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({
            custom_message: customMessage
        }),
        success: function(response) {
            $('#rescheduleModal').modal('hide');
            showAlert('[OK] Appointment rescheduled! Email with your available times sent to student.', 'success');
            loadAppointments();
        },
        error: function(xhr) {
            const errorMessage = xhr.responseJSON?.error || 'Error rescheduling appointment';
            showAlert(errorMessage, 'danger');
        }
    });
}

function deleteAppointment(appointmentId) {
    $.ajax({
        url: `/complaints/appointments/${appointmentId}`,
        method: 'DELETE',
        success: function(response) {
            $('#deleteModal').modal('hide');
            showAlert(response.message, 'success');
            loadAppointments();
        },
        error: function(xhr) {
            const errorMessage = xhr.responseJSON?.error || 'Error deleting appointment';
            showAlert(errorMessage, 'danger');
        }
    });
}

function deleteAllAppointments() {
    $.ajax({
        url: '/complaints/appointments/all',
        method: 'DELETE',
        success: function(response) {
            $('#deleteAllModal').modal('hide');
            showAlert(response.message, 'success');
            loadAppointments();
        },
        error: function(xhr) {
            const errorMessage = xhr.responseJSON?.error || 'Error deleting all appointments';
            showAlert(errorMessage, 'danger');
        }
    });
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-triangle'}"></i>
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    `;
    $('body').append(alertHtml);
    
    // Auto-dismiss after 5 seconds
    setTimeout(function() {
        $('.alert').fadeOut();
    }, 5000);
}
</script>
{% endblock %}
